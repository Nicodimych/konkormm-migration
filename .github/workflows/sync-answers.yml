name: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ Issues

on:
  push:
    branches:
      - master
    paths:
      - 'QUESTIONS.md'

permissions:
  contents: read
  issues: write

jobs:
  sync-answers-to-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: –ù–∞–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        id: find-answers
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('QUESTIONS.md', 'utf8');
            
            // –ò—â–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã —Å –Ω–æ–º–µ—Ä–∞–º–∏ Issues
            const questionRegex = /### ‚ùì (\d+)\. (.*?)\n\n\*\*–ê–≤—Ç–æ—Ä:\*\* (.*?)\n\*\*–í–æ–ø—Ä–æ—Å:\*\*(.*?)\n\*\*–°—Ç–∞—Ç—É—Å:\*\* (.*?)\n\*\*–î–µ–¥–ª–∞–π–Ω:\*\* (.*?)\n\*\*GitHub Issue:\*\* #(\d+)\n\n\*\*–û—Ç–≤–µ—Ç:\*\*(.*?)(?=\n---|\n### ‚ùì|\n## |$)/gs;
            
            const matches = [...content.matchAll(questionRegex)];
            
            for (const match of matches) {
              const issueNumber = match[7];
              const answer = match[8].trim();
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
              if (answer && !answer.includes('_–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –æ—Ç–≤–µ—Ç') && answer.length > 50) {
                console.log(`–ù–∞–π–¥–µ–Ω –æ—Ç–≤–µ—Ç –Ω–∞ Issue #${issueNumber}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber
                });
                
                // –ò—â–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å –æ—Ç–≤–µ—Ç–æ–º –æ—Ç –±–æ—Ç–∞
                const existingAnswer = comments.data.find(c => 
                  c.user.login === 'github-actions[bot]' && 
                  c.body.includes('## ü§ñ –û—Ç–≤–µ—Ç –æ—Ç AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞')
                );
                
                const formattedAnswer = `## ü§ñ –û—Ç–≤–µ—Ç –æ—Ç AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞\n\n${answer}`;
                
                if (existingAnswer) {
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: existingAnswer.id,
                    body: formattedAnswer
                  });
                  console.log(`–û–±–Ω–æ–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –≤ Issue #${issueNumber}`);
                } else {
                  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: formattedAnswer
                  });
                  console.log(`–î–æ–±–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –≤ Issue #${issueNumber}`);
                }
              }
            }

